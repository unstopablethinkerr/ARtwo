<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Viewport meta tag for responsive design -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Fruit Detection with Teachable Machine</title>
  <style>
    /* Reset some default styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: #222;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
    }
    h1 {
      margin: 10px 0;
      font-size: 1.2em;
      text-align: center;
    }
    /* Container to hold the webcam canvas */
    #webcam-container {
      width: 100%;
      max-width: 400px;
      margin: 10px auto;
    }
    /* Slider container styling */
    #slider-container {
      width: 80%;
      max-width: 400px;
      margin: 10px auto;
      text-align: center;
    }
    input[type="range"] {
      width: 100%;
    }
    /* Label container for predictions */
    #label-container {
      width: 80%;
      max-width: 400px;
      margin: 10px auto;
      text-align: center;
      font-size: 1.1em;
    }
    /* Button styling */
    button {
      padding: 10px 20px;
      font-size: 1em;
      margin-bottom: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Fruit Detection Model</h1>
  <button type="button" onclick="init()">Start</button>
  
  <!-- Slider for adjusting threshold -->
  <div id="slider-container">
    <label for="thresholdSlider">Threshold: <span id="thresholdValue">50</span>%</label><br />
    <input type="range" id="thresholdSlider" min="1" max="100" value="50" />
  </div>
  
  <!-- Container for the webcam feed -->
  <div id="webcam-container"></div>
  
  <!-- Container for displaying predictions -->
  <div id="label-container"></div>

  <!-- Load TensorFlow.js and the Teachable Machine image library -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  
  <script type="text/javascript">
    // The base URL for your Teachable Machine model files
    const URL = "./my_model/";

    let model, webcam, labelContainer, maxPredictions;
    // Default threshold value (50% -> 0.5)
    let threshold = 0.5;
    
    // Update threshold value when the slider is moved
    document.getElementById("thresholdSlider").addEventListener("input", function(){
      threshold = this.value / 100; // Convert slider value (1-100) to 0-1 scale
      document.getElementById("thresholdValue").textContent = this.value;
    });
    
    // Initialize the model and webcam
    async function init() {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";
      
      // Load the Teachable Machine model and its metadata
      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();
      
      // Set up the webcam.
      // For a portrait-friendly view, we'll use the full device width.
      const webcamWidth = window.innerWidth > 400 ? 400 : window.innerWidth;
      // You can adjust the height as needed; here we use a 4:3 aspect ratio.
      const webcamHeight = webcamWidth * (3/4);
      
      // 'flip' the webcam if needed (true for mirrored view)
      const flip = true;
      webcam = new tmImage.Webcam(webcamWidth, webcamHeight, flip);
      await webcam.setup(); // Request access to the webcam
      await webcam.play();
      window.requestAnimationFrame(loop);
      
      // Append the webcam's canvas element to the container
      document.getElementById("webcam-container").appendChild(webcam.canvas);
      
      // Set up label container: create one div per prediction class
      labelContainer = document.getElementById("label-container");
      // Clear any previous content
      labelContainer.innerHTML = "";
      for (let i = 0; i < maxPredictions; i++) {
        labelContainer.appendChild(document.createElement("div"));
      }
    }
    
    // Main loop: update the webcam frame and run predictions
    async function loop() {
      webcam.update(); // Update the webcam frame
      await predict();
      window.requestAnimationFrame(loop);
    }
    
    // Run the model on the current webcam frame
    async function predict() {
      // The model can take in an image, video, or canvas element.
      const predictions = await model.predict(webcam.canvas);
      
      // Flag to check if any prediction meets the threshold
      let aboveThreshold = false;
      
      // Clear all previous prediction texts
      labelContainer.innerHTML = "";
      
      // Loop through each prediction from the model
      for (let i = 0; i < maxPredictions; i++) {
        const prediction = predictions[i];
        const probability = prediction.probability;
        const percent = (probability * 100).toFixed(2);
        
        // If the prediction meets or exceeds the threshold, display it
        if (probability >= threshold) {
          aboveThreshold = true;
          const classPrediction = prediction.className + ": " + percent + "%";
          const div = document.createElement("div");
          div.textContent = classPrediction;
          labelContainer.appendChild(div);
        }
      }
      
      // If no prediction meets the threshold, show a message
      if (!aboveThreshold) {
        labelContainer.innerHTML = "<div>Not in database</div>";
      }
    }
  </script>
</body>
</html>
