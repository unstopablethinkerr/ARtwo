<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Ensure the layout is mobile friendly in portrait mode -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Fruit Detection (Portrait Mode)</title>
  <style>
    /* Basic reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background: #222;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
    }
    h1 {
      margin: 10px 0;
      font-size: 1.4em;
      text-align: center;
    }
    /* Container for the webcam view */
    #webcam-container {
      width: 100%;
      max-width: 1080px;  /* portrait width */
      margin: 10px auto;
    }
    /* Slider container */
    #slider-container {
      width: 90%;
      max-width: 400px;
      margin: 10px auto;
      text-align: center;
    }
    input[type="range"] {
      width: 100%;
    }
    /* Table styling */
    #result-table {
      width: 90%;
      max-width: 400px;
      margin: 20px auto;
      border-collapse: collapse;
      text-align: left;
      font-size: 1.1em;
    }
    #result-table th,
    #result-table td {
      border: 1px solid #555;
      padding: 8px 10px;
    }
    #result-table th {
      background-color: #333;
    }
    /* Button styling */
    button {
      padding: 10px 20px;
      font-size: 1em;
      margin-bottom: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Fruit Detection Model</h1>
  <button type="button" onclick="init()">Start</button>

  <!-- Slider for threshold (1% to 100%) -->
  <div id="slider-container">
    <label for="thresholdSlider">Threshold: <span id="thresholdValue">50</span>%</label><br />
    <input type="range" id="thresholdSlider" min="1" max="100" value="50" />
  </div>

  <!-- Container for the webcam feed -->
  <div id="webcam-container"></div>

  <!-- Table to display probabilities -->
  <table id="result-table">
    <thead>
      <tr>
        <th>Fruit</th>
        <th>Probability</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Apples</td>
        <td id="apples-prob">0.00%</td>
      </tr>
      <tr>
        <td>Strawberry</td>
        <td id="strawberry-prob">0.00%</td>
      </tr>
      <tr>
        <td>Grape</td>
        <td id="grape-prob">0.00%</td>
      </tr>
      <tr>
        <td>Not in Database</td>
        <td id="not-db-prob">0.00%</td>
      </tr>
    </tbody>
  </table>

  <!-- Load TensorFlow.js and Teachable Machine image library -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
  
  <script type="text/javascript">
    // URL pointing to the folder with your model files (model.json, metadata.json, weights.bin)
    const URL = "./my_model/";

    let model, webcam;
    let maxPredictions;
    // Default threshold (50% as 0.5)
    let threshold = 0.5;

    // Update threshold when the slider is moved
    document.getElementById("thresholdSlider").addEventListener("input", function(){
      threshold = this.value / 100;
      document.getElementById("thresholdValue").textContent = this.value;
    });
    
    // Initialize the Teachable Machine model and webcam
    async function init() {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      // Load the model and metadata
      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      // Set up the webcam.
      // Request a portrait feed with 1080x1920.
      // The flip parameter is set to false so the image is not mirrored.
      const flip = false;
      // Note: Not all devices will support the exact resolution.
      webcam = new tmImage.Webcam(1080, 1920, flip, {facingMode: "environment"});
      await webcam.setup(); // request access
      await webcam.play();
      window.requestAnimationFrame(loop);

      // Append the webcam canvas to the container.
      document.getElementById("webcam-container").appendChild(webcam.canvas);
    }
    
    // Main loop: update the webcam frame and run predictions.
    async function loop() {
      webcam.update();
      await predict();
      window.requestAnimationFrame(loop);
    }
    
    // Run the model on the current webcam frame and update the table.
    async function predict() {
      // The model can take an image, video, or canvas element.
      const predictions = await model.predict(webcam.canvas);

      // Create an object to store probabilities for our target fruits.
      // (Use lower case for comparisons.)
      let results = {
        apples: 0,
        strawberry: 0,
        grape: 0
      };

      // Flag indicating whether any prediction meets or exceeds the threshold.
      let meetsThreshold = false;

      // Loop through the predictions.
      predictions.forEach(prediction => {
        // Standardize the class name (assuming the model's class names match one of these)
        const className = prediction.className.toLowerCase();
        const prob = prediction.probability; // a value between 0 and 1

        if ( (className === "apples" || className === "apple") && prob >= threshold ) {
          results.apples = prob;
          meetsThreshold = true;
        } else if ((className === "strawberry" || className === "strawberries") && prob >= threshold) {
          results.strawberry = prob;
          meetsThreshold = true;
        } else if ((className === "grape" || className === "grapes") && prob >= threshold) {
          results.grape = prob;
          meetsThreshold = true;
        }
      });

      // Update table cells:
      // If at least one prediction meets threshold, show those probabilities (as percentage with two decimals).
      // Otherwise, show 0% for fruits and 100% for "Not in Database".
      if (meetsThreshold) {
        document.getElementById("apples-prob").textContent = (results.apples * 100).toFixed(2) + "%";
        document.getElementById("strawberry-prob").textContent = (results.strawberry * 100).toFixed(2) + "%";
        document.getElementById("grape-prob").textContent = (results.grape * 100).toFixed(2) + "%";
        document.getElementById("not-db-prob").textContent = "0.00%";
      } else {
        // If none meet the threshold, show 0% for each fruit and 100% for Not in Database.
        document.getElementById("apples-prob").textContent = "0.00%";
        document.getElementById("strawberry-prob").textContent = "0.00%";
        document.getElementById("grape-prob").textContent = "0.00%";
        document.getElementById("not-db-prob").textContent = "100.00%";
      }
    }
  </script>
</body>
</html>
